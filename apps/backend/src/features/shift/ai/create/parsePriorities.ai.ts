import type { parsePrioritiesFromAiInput } from "@shared/api/shift/ai/types/post-create.js";
import openai from "../../../../config/openai.js";

export const parsePrioritiesFromAi = async ({
	ownerRequests,
	submittedShifts,
}: parsePrioritiesFromAiInput): Promise<string> => {
	const prompt = `
    ä»¥ä¸‹ã¯ã‚ªãƒ¼ãƒŠãƒ¼ã‹ã‚‰ã®ã‚·ãƒ•ãƒˆèª¿æ•´å¸Œæœ›ï¼ˆè‡ªç„¶è¨€èªï¼‰ã§ã™ã€‚
    ã“ã®å†…å®¹ã‚’ã‚‚ã¨ã«ã€å„ã‚¹ã‚¿ãƒƒãƒ•ã«é–¢ã™ã‚‹å„ªå…ˆåº¦ãƒ‡ãƒ¼ã‚¿ï¼ˆPriorityType[]ï¼‰ã‚’**å³å¯†ãªå½¢å¼**ã§æ§‹é€ åŒ–ã—ã¦ãã ã•ã„ã€‚
    ã¾ãŸã€ownerRequests ã®å†…å®¹ã‚’ã‚‚ã¨ã«ã€ã‚¹ã‚¿ãƒƒãƒ•ã®å¸Œæœ›ã‚„å„ªå…ˆåº¦ã‚’è€ƒæ…®ã—ã¦ã€æ•´åˆæ€§ã®å–ã‚ŒãŸã‚·ãƒ•ãƒˆã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚åŠ ãˆã¦ã€ownerRequests ã®è¦ç´ ã¯ã€å„ªå…ˆåº¦ã®é«˜ã„é †ã«æ•´åˆ—ã•ã‚Œã¦ã„ã¾ã™ã€‚

    # âœ… å…¥åŠ›ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
    ownerRequests: { text: string, weight: number }[]

    - \`text\`: ã‚¹ã‚¿ãƒƒãƒ•ã«å¯¾ã™ã‚‹å¸Œæœ›ãƒ»èª¿æ•´å†…å®¹ãŒè¨˜è¼‰ã•ã‚ŒãŸè‡ªç„¶è¨€èªã§ã™ã€‚
    - \`weight\`: å¸Œæœ›ã®å¼·ã•ã‚’ç¤ºã™æ•°å€¤ã§ã€1ã€œ3ã®æ•´æ•°ã§ã™ï¼ˆ3ãŒæœ€ã‚‚å¼·ã„å¸Œæœ›ï¼‰ã€‚

    # âœ… å‡ºåŠ›å½¢å¼ï¼ˆJSONã®ã¿ã€æ³¨é‡ˆç¦æ­¢ï¼‰
    \`\`\`json
    [
      {
        "userId": "user-1",
        "userName": "é«˜æ©‹æœªæ¥",
        "preferTime": "afternoon",
        "preferredDays": ["Monday", "Thursday"],
        "preferMoreThan": [
          { "userId": "user-2", "userName": "ä¼Šè—¤å„ªå­" }
        ],
        "weight": 3
      },
      ...
    ]
    \`\`\`

    # ğŸ” å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®æ„å‘³ã¨ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«

    - **userId / userName**:
      - ã‚¹ã‚¿ãƒƒãƒ•ã®è­˜åˆ¥æƒ…å ±ã§ã™ã€‚å¿…ãš ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆ ã‹ã‚‰å–å¾—ã—ã¦ãã ã•ã„ã€‚

    - **preferTime**:
      - ã‚¹ã‚¿ãƒƒãƒ•ãŒå¸Œæœ›ã™ã‚‹æ™‚é–“å¸¯ã€‚ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®å½¢å¼ã‚’ä½¿ç”¨ï¼š
        - "morning" â†’ åˆå‰å¸Œæœ›ï¼ˆä¾‹: 09:00ã€œ12:00 ãªã©ï¼‰
        - "afternoon" â†’ åˆå¾Œå¸Œæœ›ï¼ˆä¾‹: 13:00ã€œ18:00 ãªã©ï¼‰
        - ã¾ãŸã¯æ˜ç¢ºãªæ™‚é–“å¸¯æŒ‡å®šãŒã‚ã‚‹å ´åˆ â†’ { "start": "HH:MM", "end": "HH:MM" }

    - **preferredDays**:
      - ã€Œã€‡æ›œæ—¥ãŒã„ã„ã€ã€Œç«ãƒ»æœ¨ä¸­å¿ƒã§ã€ãªã©ã®è¡¨ç¾ã«å¯¾å¿œã€‚æ›œæ—¥ã¯ "Monday"ã€œ"Sunday" ã®è‹±èªè¡¨è¨˜ã§è¨˜è¿°ã€‚

    - **preferMoreThan**:
      - ã€Œã€œã‚ˆã‚Šå„ªå…ˆã€ã€Œã€œã‚ˆã‚Šå¤šã‚ã«ã€ãªã©ã®æ¯”è¼ƒæŒ‡ç¤ºã«å¯¾ã—ã¦ä½¿ç”¨ã€‚
      - å¯¾è±¡ã¨ãªã‚‹ userId / userName ã®ãƒšã‚¢ã‚’é…åˆ—ã§å«ã‚ã¦ãã ã•ã„ã€‚

    - **weight**:
      - ownerRequests ã® weight å€¤ã‚’åæ˜ ã—ã¦ãã ã•ã„ã€‚èª¿æ•´å¸Œæœ›ã®å¼·ã•ã‚’è¡¨ã—ã¾ã™ã€‚
      - æ˜ç¢ºã«ã€Œæœ€å„ªå…ˆã€ã€Œãªã‚‹ã¹ãå¤šãã€ãªã©ãŒã‚ã‚‹å ´åˆã¯ 3ã€æ§ãˆã‚ãªå¸Œæœ›ã§ã‚ã‚Œã° 1ã€œ2ã€‚

    ---

    # ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆï¼ˆuserId / userName ä¸€è¦§ï¼‰
    ${JSON.stringify(
			submittedShifts.map(({ userId, name }) => ({ userId, userName: name })),
			null,
			2,
		)}

    ---

    # ğŸ’¬ ã‚ªãƒ¼ãƒŠãƒ¼ã®å¸Œæœ›ï¼ˆè‡ªç„¶è¨€èª + weightï¼‰
    ${JSON.stringify(ownerRequests, null, 2)}

    ---

    # âœ… å‡ºåŠ›ãƒ«ãƒ¼ãƒ«
    - JSONé…åˆ—å½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆPriorityType[]ï¼‰
    - ã‚¹ã‚¿ãƒƒãƒ•ã”ã¨ã«å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã¿å«ã‚ã¦OKï¼ˆã™ã¹ã¦å«ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰
    - æ³¨é‡ˆã€èª¬æ˜æ–‡ã€ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å¤–ã®æ–‡è¨€ã¯ä¸€åˆ‡ä¸è¦
`;

	const response = await openai.chat.completions.create({
		model: "gpt-4o",
		messages: [
			{
				role: "system",
				content:
					"ã‚ãªãŸã¯ã‚·ãƒ•ãƒˆä½œæˆAIã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª¿æ•´å¸Œæœ›ã‚’å…ƒã«ã€å¸Œæœ›ã‚„äººæ•°ãƒãƒ©ãƒ³ã‚¹ã€å„ªå…ˆåº¦æƒ…å ±ã‚’è€ƒæ…®ã—ã€æ•´åˆæ€§ã®å–ã‚ŒãŸã‚·ãƒ•ãƒˆã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
			},
			{
				role: "user",
				content: prompt,
			},
		],
	});

	return response.choices[0].message?.content ?? "";
};
